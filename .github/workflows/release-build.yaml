# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release Build
on:
  workflow_call:
    inputs:
      tag:
        description: "Release tag"
        required: true
        type: string
    outputs:
      artifacts:
        description: "List of built artifacts"
        value: ${{ jobs.build-matrix.outputs.artifacts }}

permissions: {}

concurrency:
  group: release-build-${{ inputs.tag }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"

jobs:
  build-matrix:
    name: build-${{ matrix.target }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read # Required to checkout the repository
      actions: write # Required to upload artifacts
    outputs:
      artifacts: ${{ steps.collect-artifacts.outputs.artifacts }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-pc-windows-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Extract tool versions
        id: versions
        run: |
          sccache_version=$(grep -E '^ARG SCCACHE_VERSION=v?[0-9]+\.[0-9]+\.[0-9]+' Dockerfile | sed -E 's/ARG SCCACHE_VERSION=(v?[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          zigbuild_version=$(grep -E '^ARG ZIGBUILD_VERSION=v?[0-9]+\.[0-9]+\.[0-9]+' Dockerfile | sed -E 's/ARG ZIGBUILD_VERSION=(v?[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          package_name=$(grep -E '^\[package\]' -A 10 Cargo.toml | grep -E '^name = "' | sed -E 's/name = "(.*)"/\1/')

          if grep -q '^\[\[bin\]\]' Cargo.toml; then
            main_bin=$(grep -E '^\[\[bin\]\]' -A 10 Cargo.toml | grep -E '^name = "'"$package_name"'"' | sed -E 's/name = "(.*)"/\1/')
            binary_name=${main_bin:-$(grep -E '^\[\[bin\]\]' -A 10 Cargo.toml | grep -E '^name = "' | head -n 1 | sed -E 's/name = "(.*)"/\1/')}
          else
            binary_name="$package_name"
          fi

          {
            echo "sccache=${sccache_version}"
            echo "zigbuild=${zigbuild_version}"
            echo "package_name=${package_name}"
            echo "binary_name=${binary_name}"
          } >> "$GITHUB_OUTPUT"

      - name: Rust setup
        uses: ./.github/actions/act-setup-rust
        with:
          sccache: ${{ steps.versions.outputs.sccache }}

      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@288875dd3d64326724fa6d9593062d9f8ba0b131 # v2.67.30
        with:
          tool: cargo-zigbuild@${{ steps.versions.outputs.zigbuild }}

      - name: Build release binary
        env:
          TARGET: ${{ matrix.target }}
        run: |
          set -euxo pipefail
          # Disable mold for cross-compilation (zigbuild handles linking)
          unset RUSTFLAGS
          cargo zigbuild --release --target "${TARGET}" --verbose

      - name: Set binary extension
        id: binary-ext
        env:
          TARGET: ${{ matrix.target }}
        run: |
          if [[ "${TARGET}" == *windows* ]]; then
            echo "ext=.exe" >> "$GITHUB_OUTPUT"
          else
            echo "ext=" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload binary artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        env:
          BINARY_NAME: ${{ steps.versions.outputs.binary_name }}
          TAG: ${{ inputs.tag }}
          TARGET: ${{ matrix.target }}
          BINARY_EXT: ${{ steps.binary-ext.outputs.ext }}
        with:
          name: ${{ env.BINARY_NAME }}-${{ env.TAG }}-${{ env.TARGET }}
          path: target/${{ env.TARGET }}/release/${{ env.BINARY_NAME }}${{ env.BINARY_EXT }}
          if-no-files-found: error
          retention-days: 7

      - name: Collect artifact info
        id: collect-artifacts
        env:
          BINARY_NAME: ${{ steps.versions.outputs.binary_name }}
          TAG: ${{ inputs.tag }}
          TARGET: ${{ matrix.target }}
          BINARY_EXT: ${{ steps.binary-ext.outputs.ext }}
        run: |
          artifact_name="${BINARY_NAME}-${TAG}-${TARGET}"
          binary_path="target/${TARGET}/release/${BINARY_NAME}${BINARY_EXT}"
          echo "artifacts=${artifact_name}:${binary_path}" >> "$GITHUB_OUTPUT"
